#!/bin/bash

# Configuration
dest="$1"
shift

# Check if media is available
if [ ! -d "$dest" ]; then
    echo "No backup media found"
    exit 1
fi

dest=$(abspath "$dest")

# Directory names
current="$dest/$(date "+%Y-%m-%d_%H.%M.%S")"
latest="$dest/LATEST"

# RSYNC each of the source directories and create hard links for untouched files
for src in "$@"
do
    src=$(abspath "$src")
    if [ ! -d "$src" ]; then
        echo "WARNING: $source does not exist!"
    else
        mkdir -p "$current$src"
        rsync -vaL --link-dest="$latest$src" "$src" "$current$src"
    fi
done

# Replace the LATEST link
if [ -d "$current" ]; then
    rm -f "$latest"
    ln -s "$current" "$latest"
fi
