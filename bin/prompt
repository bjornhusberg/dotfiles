#!/bin/bash

LINE="\342\224\200"
CORNER_UL="\342\224\214"
CORNER_UR="\342\224\220"
CORNER_LL="\342\224\224"
CORNER_LR="\342\224\230"

RESET="\[\033[0m\]"
GREEN="\[\033[1;32m\]"
YELLOW="\[\033[1;33m\]"
PINK="\[\033[1;35m\]"
CYAN="\[\033[1;36m\]"
RED="\[\033[1;31m\]"
PURPLE="\[\033[1;34m\]"

if [ "$PROMPT_STYLE" == "server" ]; then
  LINE_COLOR="$RED"
  FRAME_COLOR="$PINK"
else
  LINE_COLOR="$CYAN"
  FRAME_COLOR="$PURPLE"
fi

FRAME_BEGIN="$FRAME_COLOR$LINE("
FRAME_END="$FRAME_COLOR)$LINE"

if [ "$COLUMNS" == "" ]; then
  COLUMNS=$(tput cols)
fi

if [[ ! -z "$PROMPT_EXIT" && "$PROMPT_EXIT" != "0" ]]; then
  exitCode="$FRAME_BEGIN${PINK}$PROMPT_EXIT$FRAME_END$LINE_COLOR$LINE"
else
  exitCode=""
fi

if [ -f "$HOME/.dotfiles_dirty" ]; then
  notification="$FRAME_BEGIN${PINK}!$FRAME_END$LINE_COLOR$LINE"
  notificationLength=6
else
  notification=""
  notificationLength=0
fi

if [ -z "$PROMPT_USER" ]; then
  PROMPT_USER="$USER@$HOSTNAME"
fi
userLength=$((${#PROMPT_USER} + 5))

if [ "$DEVENV" != "" ]; then
  devenv="$FRAME_BEGIN$YELLOW$DEVENV$FRAME_END$LINE_COLOR$LINE"
else
  devenv=""
fi
devenvLength=$((${#DEVENV} + 5))

if [ "${PWD:0:${#HOME}}" == "$HOME" ]; then
  directory="~${PWD:${#HOME}}"
else
  directory="${PWD}"
fi
directoryLength=$((${#directory} + 4))
padding=$(($COLUMNS - $userLength - $directoryLength - $devenvLength - $notificationLength - 2))
if [ $padding -gt 0 ]; then
  directory="$FRAME_BEGIN$PINK$directory$FRAME_END"
else
  maxdirectoryLength=$(($directoryLength + $padding))
  if [ $maxdirectoryLength -lt 8 ]; then
    padding=$(($padding + $directoryLength))
    directory=""
  else
    padding=0
    directory="$FRAME_BEGIN$PINK...${directory:$((7-$maxdirectoryLength))}$FRAME_END"
  fi
fi

echo -n "\n\033[1A$LINE_COLOR$CORNER_UL$FRAME_BEGIN$GREEN$PROMPT_USER$FRAME_END$LINE_COLOR$LINE$notification$devenv"

for ((; padding > 0; padding--)) {
  echo -n "$LINE"
}

rightBegin=$(($COLUMNS - 15))
echo -n "$directory$LINE_COLOR$CORNER_UR\033[1B\033[${rightBegin}G$LINE_COLOR$LINE$FRAME_BEGIN$YELLOW\D{%F}$FRAME_END$LINE_COLOR$CORNER_LR\033[1A\n$LINE_COLOR$CORNER_LL$exitCode$FRAME_BEGIN$YELLOW\t$FRAME_END$LINE_COLOR$LINE$RESET "
