#!/bin/bash

MAX_PARALLELL_JOBS=7

function doGit() {
  pushd . > /dev/null
  cd "${repo%%/.git}"
  shift
  git $@ > .git/rgit.log 2>&1
  popd > /dev/null
}

function progress() {
  progress=$(date +%s)
  chars="⠼⠶⠧⠏⠛⠹"
  echo -ne "\r${chars:$((progress % ${#chars})):1} "
}

repos=$(find . -type d -name ".git")

if [ ${#repos} -eq 0 ]; then
  echo "No git repositories found."
  exit 0
fi

args=$@

if [ ${#args} -eq 0 ]; then
  echo "No arguments supplied. Defaulting to 'git status --porcelain'"
  args=(status --porcelain)
  args=${args[*]}
fi

for repo in $repos; do
  # Limit number of parallell threads to unchoke the remote
  while [ $(jobs -r | grep doGit | wc -l) -gt $MAX_PARALLELL_JOBS ]; do
    sleep 0.1
    progress
  done
  progress

  doGit $repo $args &
done

wait

silentCount=0
for repo in $repos; do
  if [ -s "$repo/rgit.log" ]; then
    echo -e "\n\033[1;34m${repo%%/.git}\033[0m"
    cat "$repo/rgit.log"
  else
    silentCount=$((silentCount + 1))
  fi
  rm "$repo/rgit.log"
done

if [ $silentCount -gt 0 ]; then
  echo "Suppressed output from $silentCount silent commands"
fi
