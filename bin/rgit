#!/bin/bash

MAX_PARALLELL_JOBS=7 

function doGit() {
  pushd . > /dev/null
  cd "${repo%%/.git}"
  shift
  git $@ > .git/rgit.log 2>&1
  popd > /dev/null
}

repos=$(find . -type d -name ".git")

for repo in $repos; do
  # Limit number of parallell threads to unchoke the remote
  while [ $(jobs -r | grep doGit | wc -l) -gt $MAX_PARALLELL_JOBS ]; do
    sleep 0.1
  done

  doGit $repo $@ &
done

wait

for repo in $repos; do
  echo -e "\n\033[1;34m${repo%%/.git}\033[0m"
  cat "$repo/rgit.log"
  rm "$repo/rgit.log"
done
